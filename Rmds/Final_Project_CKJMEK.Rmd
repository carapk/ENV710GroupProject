---
title: "ENV 710 Final Project"
author: "Emma Kaufman, Cara Kuuskvere, Jenn McNeill"
date: "2024-04-10"
output: pdf_document
editor_options: 
  chunk_output_type: console
toc: true
---
```{r load packages, include=FALSE}

library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(tidyverse)
library(lubridate)
library(latex2exp)
library(lubridate)
library(lme4)

```


```{r import and wrangle data}

lakes_raw <- read.csv("./Data/Raw/NTL-LTER_Lake_Nutrients_Raw.csv",stringsAsFactors = TRUE) 
do_raw <- read.csv("Data/Raw/NTL-LTER_Lake_ChemistryPhysics_Raw.csv",stringsAsFactors = TRUE)

lakes_raw$sampledate <- mdy(lakes_raw$sampledate)
do_raw$sampledate <- mdy(do_raw$sampledate)

lakes_processed <- lakes_raw %>%
  select(lakename, sampledate, depth, tn_ug, tp_ug, nh34, no23, po4) %>%
  na.omit() %>%
  filter(lakename %in% c("Paul Lake", "West Long Lake", "Peter Lake", "East Long Lake")) %>%
  #filter(year(sampledate) >= 1994 & year(sampledate) <= 1999) %>%
  mutate(year = factor(year(sampledate)),
         month = factor(month(sampledate)),
         subsurface = factor(ifelse(depth > 6, "subsurface", "surface")),
         season = factor(ifelse(month == 5, "spring", ifelse(month == 8, "summer", NA)))) %>%
  filter(month %in% c(5,6,7,8)) %>%
  mutate(depth = round(depth * 2) / 2)

lakes_processed$subsurface_indicator <- ifelse(lakes_processed$subsurface == "subsurface", 1, 0)
lakes_processed$summer_indicator <- ifelse(lakes_processed$season == "summer", 1, 0)

lakes_processed <- left_join(lakes_processed, select(do_raw, lakename, sampledate, depth, dissolvedOxygen), by = c("lakename", "sampledate", "depth"))

lake_1994 <- lakes_processed %>% 
  filter(year %in% c(1994)) %>% 
  filter(po4<20) %>% 
  filter(tp_ug<100)

```

```{r attempt to wrangle with all years and DO less than 5}

lakes_all_years <- lakes_raw %>%
  select(lakename, sampledate, depth, tn_ug, tp_ug, nh34, no23, po4) %>%
  na.omit() %>%
  filter(lakename %in% c("Paul Lake", "West Long Lake", "Peter Lake", "East Long Lake")) %>%
  mutate(year = factor(year(sampledate)),
         month = factor(month(sampledate)),
         subsurface = factor(ifelse(depth > 1, "subsurface", "surface")),
         season = factor(ifelse(month == 5, "spring", ifelse(month == 8, "summer", NA)))) %>%
  filter(month %in% c(5,6,7,8)) %>%
  mutate(depth = round(depth * 2) / 2)

lakes_all_years$subsurface_indicator <- ifelse(lakes_all_years$subsurface == "subsurface", 1, 0)
lakes_all_years$summer_indicator <- ifelse(lakes_all_years$season == "summer", 1, 0)

lakes_all_years <- left_join(lakes_all_years, select(do_raw, lakename, sampledate, depth, dissolvedOxygen), by = c("lakename", "sampledate", "depth"))

lakes_all_years <- lakes_all_years %>%
  filter(dissolvedOxygen <= 5)

```

```{r attempt to plot all years with emmas model}

two_season_clean_new <- lakes_all_years %>% 
  na.omit()

two_season_fit_new <- lm(dissolvedOxygen ~ summer_indicator + tp_ug + summer_indicator*tp_ug,
                     data = two_season_clean_new)

summary(two_season_fit_new)

ggplot(two_season_clean_new, aes(x=tp_ug, y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_fit_new)[1],
              slope = coef(two_season_fit_new)[3],
              color = "thistle3", size = 1)+
  geom_abline(intercept = coef(two_season_fit_new)[1] + coef(two_season_fit_new)[2],
              slope = coef(two_season_fit_new)[3] + coef(two_season_fit_new)[4],
              color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  scale_x_continuous(breaks = seq(0, 300, by = 50))+
  scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Total Phosphorus" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

```



```{r Initial plots}
ggplot(lakes_processed)+
  geom_point(aes(y=dissolvedOxygen,x=subsurface_indicator))+
  theme_light()

ggplot(lakes_processed)+
  geom_point(aes(y=dissolvedOxygen,x=season))+
  theme_light()
  
```


```{r Testing and Training}
# Holdout 20% of data for testing, 80% for training
lakes_processed$holdout <- rbinom(n=nrow(lakes_processed),size=1,prob=0.2)
lakes_training <- lakes_processed %>% filter(holdout==0)
lakes_testing <- lakes_processed %>% filter(holdout==1)
```


```{r Season and Phosphorus v DO}

two_season_clean <- lakes_processed %>% 
  na.omit()

two_season_fit <- lm(dissolvedOxygen ~ summer_indicator + tp_ug + summer_indicator*tp_ug,
                     data = two_season_clean)

summary(two_season_fit)

two_season_fit_log <- lm(dissolvedOxygen ~ summer_indicator + log(tp_ug) +
                           summer_indicator*tp_ug, data = two_season_clean)

# Holdout 20% of data for testing, 80% for training

two_season_clean$holdout <- rbinom(n=nrow(two_season_clean),size=1,prob=0.2)
two_season_training <- two_season_clean %>% filter(holdout==0)
two_season_testing <- two_season_clean %>% filter(holdout==1)

two_season_fit_test <- lm(dissolvedOxygen ~ summer_indicator + tp_ug + summer_indicator*tp_ug,
                          data = two_season_training)

print(two_season_fit_test)

two_season_fit_test_beta_0 <- 10.52
two_season_fit_test_beta_1 <- -1.84
two_season_fit_test_beta_2 <- -0.06
two_season_fit_test_beta_3 <- 0.02

two_season_testing$do_predicted <- two_season_fit_test_beta_0 + 
    two_season_fit_test_beta_1*two_season_testing$summer_indicator +
    two_season_fit_test_beta_2*two_season_testing$tp_ug +
    two_season_fit_test_beta_3*two_season_testing$summer_indicator*two_season_testing$tp_ug

sqrt(mean((two_season_testing$dissolvedOxygen - two_season_testing$do_predicted)^2))

```

a. What is the estimate of $\beta_0$ and what does it represent in terms of DO (dissolved oxygen)?

$\beta_0$ for this fit is 10.22 mg/L, which represents the expected value of DO in spring with zero total phosphorus.

b. What is the estimate of $\beta_1$ and what does it represent in terms of DO?

$\beta_1$ for this fit is -1.52, which represents the difference in DO between spring and summer with zero total phosphorus. In summer the expected dissolved oxygen is 8.7 mg/L. 

c. What is the estimate of $\beta_2$ and what does it represent in terms of DO?

$\beta_2$ for this fit is -0.063 (mg/L)/ug, which represents the expected change in DO for each unit increase in total phosphorus during spring.

d. What is the estimate of $\beta_3$ and what does it represent in terms of DO?

$\beta_3$ for this fit is 0.02 (mg/L)/ug, which represents the adjustment to the slope for each unit increase in total phosphorus during the summer. In the summer the expected change in DO for each unit increase in total phosphorus is -0.045 (mg/L)/ug. 

```{r Season and Phosphorus v DO plot}

Two_Season_P <- ggplot(two_season_clean, aes(x=tp_ug, y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_fit)[1],
              slope = coef(two_season_fit)[3],
              color = "thistle3", size = 1)+
  geom_abline(intercept = coef(two_season_fit)[1] + coef(two_season_fit)[2],
              slope = coef(two_season_fit)[3] + coef(two_season_fit)[4],
              color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  scale_x_continuous(breaks = seq(0, 300, by = 50))+
  scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Total Phosphorus" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

Two_Season_P

```

```{r looking at residuals for season and phosphorus and MAPE}

plot(two_season_fit)

```
**discuss the poor model fit in results and talk about how we attempted to log transform the x axis and tried to use a subset of the y axis dissolved oxygen, but we still didn't see normal distribution of residuals or constant variance of residuals. reference the plots but include them in the appendix.

```{r jenn model}

jenn <- lakes_processed

jenn$subsurface_tp_ug = jenn$tp_ug * jenn$subsurface_indicator
jenn$subsurface_tn_ug = jenn$tn_ug * jenn$subsurface_indicator

jenn_fit_p <- lm(formula = dissolvedOxygen ~ subsurface_indicator + tp_ug + subsurface_tp_ug, 
                 data = jenn)

print(jenn_fit_p)

plot(jenn_fit_p)

# Holdout 20% of data for testing, 80% for training

jenn$holdout <- rbinom(n=nrow(jenn),size=1,prob=0.2)
jenn_training <- jenn %>% filter(holdout==0)

jenn_testing <- jenn %>% filter(holdout==1)

jenn_fit_p_test <- lm(formula = dissolvedOxygen ~ subsurface_indicator + tp_ug + subsurface_tp_ug, data = jenn_training)

print(jenn_fit_p_test)

jenn_fit_p_test_beta_0 <- 8.56
jenn_fit_p_test_beta_1 <- -7.70
jenn_fit_p_test_beta_2 <- 0.00
jenn_fit_p_test_beta_3 <- 0.00

jenn_testing$do_predicted <- jenn_fit_p_test_beta_0 + 
    jenn_fit_p_test_beta_1*jenn_testing$subsurface_indicator +
    jenn_fit_p_test_beta_2*jenn_testing$tp_ug +
    jenn_fit_p_test_beta_3*jenn_testing$subsurface_tp_ug

sqrt(mean((jenn_testing$dissolvedOxygen - jenn_testing$do_predicted)^2, na.rm = TRUE))

```

**CHANGE ALL OF THESE VALUES
a. What is the estimate of $\beta_0$ and what does it represent in terms of DO?

$\beta_0$ for this fit is 8.65 mg/L, which represents the expected value of DO in surface water with zero total phosphorus.

b. What is the estimate of $\beta_1$ and what does it represent in terms of DO?

$\beta_1$ for this fit is -0.55 mg/L, which represents the difference in DO between surface water and subsurface water with zero total phosphorus.

c. What is the estimate of $\beta_2$ and what does it represent in terms of DO?

$\beta_2$ for this fit is -0.0002 (mg/L)/ug, which represents the expected change in DO for each unit increase in total phosphorus in surface water.

d. What is the estimate of $\beta_3$ and what does it represent in terms of DO?

$\beta_3$ for this fit is -0.046 (mg/L)/ug, which represents the adjustment to the slope for each unit increase in total phosphorus in subsurface water.


```{r jenn plot}

#plot total phosphorus versus dissolved oxygen
ggplot(jenn, aes(x=tp_ug, y=dissolvedOxygen, color=subsurface))+
  geom_point()+
  geom_abline(intercept = coef(jenn_fit_p)[1], 
              slope = coef(jenn_fit_p)[3], 
              color = "steelblue1", size = 1)+
  geom_abline(intercept = coef(jenn_fit_p)[1] + coef(jenn_fit_p)[2], 
              slope = coef(jenn_fit_p)[3] + coef(jenn_fit_p)[4], 
              color = "steelblue4", size = 1)+
  scale_color_manual(values = c("surface" = "steelblue1", "subsurface" = "steelblue4"))+
  scale_x_continuous(breaks = seq(0, 300, by = 50))+
  scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("total phosphorus" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "depth")

```


```{r Heirarchical }
# Fit hierarchical linear mixed-effects model
fit <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_processed)

# Summary of the model
summary(fit)

# Print the model
print(fit)

# Extract the random effects
random_effects <- fit@u

# Holdout 20% of data for testing, 80% for training
fit_test <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_training)

print(fit_test)

fit_test_beta_0 <- 8.689
fit_test_beta_1 <- -0.055

lakes_testing$do_predicted <- fit_test_beta_0 + 
    fit_test_beta_1*lakes_testing$tp_ug

sqrt(mean((lakes_testing$dissolvedOxygen - lakes_testing$do_predicted)^2, na.rm = TRUE))

# Plotting the relationship between total phosphorus (tp_ug) and dissolved oxygen (dissolvedOxygen) by lakename
ggplot(lakes_processed, aes(x = tp_ug, y = dissolvedOxygen, color = lakename)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +  # Add a linear regression line
  labs(x = "Total Phosphorus (µg)", y = "Dissolved Oxygen (mg/L)", color = "Lake Name") +
  theme_minimal() +
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Lake") +
  theme(legend.position = "bottom")


```

**CHANGE
a. $\beta_0$ (Intercept): 9.31581

This represents the expected value of dissolved oxygen in surface water with zero total phosphorus.

b. $\beta_1$ (tp_ug): -0.05593

This represents the change in dissolved oxygen for each unit increase in total phosphorus in surface water.


```{r Heirarchical analysis}
# Residual Plot (Residuals vs Fitted)
residuals <- resid(fit)
fitted_values <- fitted(fit)

residual_plot <- data.frame(residuals = residuals, fitted_values = fitted_values)

ggplot(residual_plot, aes(x = fitted_values, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Fitted Values", y = "Residuals") +
  ggtitle("Residuals vs Fitted")

# QQ Plot (Normal Q-Q plot)
qq_plot <- qqnorm(residuals, main = "Normal Q-Q Plot")

# Random Effects Plot (Dot plot of random effects)
random_effects <- ranef(fit)$lakename

random_effects_plot <- data.frame(lakename = rownames(random_effects), random_effect = random_effects[, 1])

```



## APPENDIX
```{r import and wrangle data}

# lakes_raw <- read.csv("./Data/Raw/NTL-LTER_Lake_Nutrients_Raw.csv",stringsAsFactors = TRUE) 
# lakes_new <- read_csv("Data/Raw/NTL-LTER_Lake_ChemistryPhysics_Raw.csv")
# 
# lakes_raw$sampledate <- mdy(lakes_raw$sampledate)
# 
# lakes_processed <- lakes_raw %>%
#   select(lakename, sampledate, depth, tn_ug, tp_ug, nh34, no23, po4) %>%
#   na.omit() %>%
#   filter(lakename %in% c("Paul Lake", "West Long Lake", "Peter Lake", "East Long Lake")) %>%
#   filter(year(sampledate) >= 1994 & year(sampledate) <= 1999) %>%
#   mutate(year = factor(year(sampledate)),
#          month = factor(month(sampledate)),
#          deep = factor(ifelse(depth > 6, 1, 0))) %>%
#   filter(month %in% c(5,6,7,8))
# 
# lake_1994 <- lakes_processed %>% 
#   filter(year %in% c(1994)) %>% 
#   filter(po4<20) %>% 
#   filter(tp_ug<100)
# 
# lakes_new$sampledate <- mdy(lakes_new$sampledate)
# 
# lakes_chem_processed <- lakes_new %>%
#   select(lakename, sampledate, depth, temperature_C, dissolvedOxygen) %>%
#   na.omit() %>%
#   filter(lakename %in% c("Paul Lake", "West Long Lake", "Peter Lake", "East Long Lake")) %>%
#   filter(year(sampledate) == 1994) %>%
#   mutate(year = factor(year(sampledate)),
#          month = factor(month(sampledate)),
#          deep = factor(ifelse(depth > 6, 1, 0))) %>%
#   filter(month %in% c(5,6,7,8))

```

```{r log transformation of emma's model x axis}

Two_Season_P_log <- ggplot(two_season_clean, aes(x=log(tp_ug), y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_fit_log)[1],
              slope = coef(two_season_fit_log)[3],
              color = "thistle3", size = 1)+
  geom_abline(intercept = coef(two_season_fit_log)[1] + coef(two_season_fit_log)[2],
              slope = coef(two_season_fit_log)[3] + coef(two_season_fit_log)[4],
              color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  #scale_x_continuous(breaks = seq(0, 300, by = 50))+
  #scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Log Transformed Total Phosphorus" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

Two_Season_P_log

```


```{r tp by year with po4}

fit_1 <- lm(formula = tp_ug ~ year + po4, data = lakes_processed)
print(fit_1)

ggplot(lakes_processed, aes(x=po4, y=tp_ug, color=year))+
  geom_point()+
  geom_abline(intercept = coef(fit_1)[1], slope = coef(fit_1)[7], 
              color = "orchid3")+
  geom_abline(intercept = coef(fit_1)[1] + coef(fit_1)[2], slope = coef(fit_1)[7], 
              color = "cyan4")+
  geom_abline(intercept = coef(fit_1)[1] + coef(fit_1)[3], slope = coef(fit_1)[7], 
              color = "slateblue")+
  geom_abline(intercept = coef(fit_1)[1] + coef(fit_1)[4], slope = coef(fit_1)[7], 
              color = "tomato3")+
  geom_abline(intercept = coef(fit_1)[1] + coef(fit_1)[5], slope = coef(fit_1)[7], 
              color = "skyblue1")+
  geom_abline(intercept = coef(fit_1)[1] + coef(fit_1)[6], slope = coef(fit_1)[7], 
              color = "limegreen")+
  scale_color_manual(values = c("1994" = "orchid3", 
                                "1995" = "cyan4",
                                "1996" = "slateblue",
                                "1997" = "tomato3",
                                "1998" = "skyblue1",
                                "1999" = "limegreen"))+
  scale_x_continuous(breaks = seq(0, 200, by = 20))+
  scale_y_continuous(breaks = seq(0, 300, by = 50))+
  ylab(expression("Total Phosphorus" ~ (µg))) +
  xlab(expression("Phosphate" ~ (µg))) +
  ggtitle("Change in Total Phosphorus in Samples Taken 
in 1994, 1995, 1996, 1997, 1998, and 1999")+
  theme_light()+
  theme(legend.position="bottom")

```

```{r tp by month with po4}

fit_2 <- lm(formula = tp_ug ~ month + po4, data = lake_1994)
print(fit_2)

ggplot(lake_1994, aes(x=po4, y=tp_ug, color=month))+
  geom_point()+
  geom_abline(intercept = coef(fit_2)[1], slope = coef(fit_2)[5], 
              color = "orchid3")+
  geom_abline(intercept = coef(fit_2)[1] + coef(fit_2)[2], slope = coef(fit_2)[5], 
              color = "cyan4")+
  geom_abline(intercept = coef(fit_2)[1] + coef(fit_2)[3], slope = coef(fit_2)[5], 
              color = "slateblue")+
  geom_abline(intercept = coef(fit_2)[1] + coef(fit_2)[4], slope = coef(fit_2)[5], 
              color = "tomato3")+
  scale_color_manual(values = c("5" = "orchid3", 
                                "6" = "cyan4",
                                "7" = "slateblue",
                                "8" = "tomato3"))+
  #scale_x_continuous(breaks = seq(0, 200, by = 20))+
  #scale_y_continuous(breaks = seq(0, 300, by = 50))+
  ylab(expression("Total Phosphorus" ~ (µg))) +
  xlab(expression("Phosphate" ~ (µg))) +
  ggtitle("Change in Total Phosphorus in Samples Taken 
in May, June, July, and August")+
  theme_light()+
  theme(legend.position="bottom")

```

```{r tp by deepness binary indicator with po4}

fit_3 <- lm(formula = tp_ug ~ deep + po4, data = lake_1994)
print(fit_3)

ggplot(lake_1994, aes(x=po4, y=tp_ug, color=deep))+
  geom_point()+
  geom_abline(intercept = coef(fit_3)[1], slope = coef(fit_3)[3], 
              color = "orchid3")+
  geom_abline(intercept = coef(fit_3)[1] + coef(fit_3)[2], slope = coef(fit_3)[3], 
              color = "cyan4")+
  scale_color_manual(values = c("0" = "orchid3", 
                                "1" = "cyan4"))+
  #scale_x_continuous(breaks = seq(0, 20, by = 20))+
  #scale_y_continuous(breaks = seq(0, 100, by = 50))+
  ylab(expression("Total Phosphorus" ~ (µg))) +
  xlab(expression("Phosphate" ~ (µg))) +
  ggtitle("Change in Total Phosphorus in Samples Taken 
Above and Below 6 ft Water Depth")+
  theme_light()+
  theme(legend.position="bottom")

```

```{r tp by lake with po4}

fit_4 <- lm(formula = tp_ug ~ lakename + po4, data = lake_1994)
print(fit_4)

ggplot(lake_1994, aes(x=po4, y=tp_ug, color=lakename))+
  geom_point()+
  geom_abline(intercept = coef(fit_4)[1], slope = coef(fit_4)[5], 
              color = "orchid3")+
  geom_abline(intercept = coef(fit_4)[1] + coef(fit_4)[2], slope = coef(fit_4)[5], 
              color = "cyan4")+
  geom_abline(intercept = coef(fit_4)[1] + coef(fit_4)[3], slope = coef(fit_4)[5], 
              color = "slateblue")+
  geom_abline(intercept = coef(fit_4)[1] + coef(fit_4)[4], slope = coef(fit_4)[5], 
              color = "tomato3")+
  scale_color_manual(values = c("East Long Lake" = "orchid3", 
                                "Paul Lake" = "cyan4",
                                "Peter Lake" = "slateblue",
                                "West Long Lake" = "tomato3"))+
  scale_x_continuous(breaks = seq(0, 200, by = 20))+
  scale_y_continuous(breaks = seq(0, 300, by = 50))+
  ylab(expression("Total Phosphorus" ~ (µg))) +
  xlab(expression("Phosphate" ~ (µg))) +
  ggtitle("Change in Total Phosphorus in Samples Taken 
at East Long Lake, Paul Lake, Peter Lake, and West Long Lake")+
  theme_light()+
  theme(legend.position="bottom")

```



```{r exploratory for appendix, looking at nitrogen and season v DO}

two_season_nitrogen <- lm(dissolvedOxygen ~ summer_indicator + tn_ug + summer_indicator*tn_ug,
                     data= two_season_clean)

 ggplot(two_season_clean, aes(x=tn_ug, y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_nitrogen)[1],
              slope = coef(two_season_nitrogen)[3],
              color = "thistle3", size = 1)+
  geom_abline(intercept = coef(two_season_nitrogen)[1] + coef(two_season_nitrogen)[2],
              slope = coef(two_season_nitrogen)[3] + coef(two_season_nitrogen)[4],
              color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  # scale_x_continuous(breaks = seq(0, 300, by = 50))+
  # scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Total Nitrogen" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

```


```{r for the appendix}

jenn_fit_n <- lm(formula = dissolvedOxygen ~ subsurface + tn_ug + subsurface_tn_ug, 
                 data = jenn)

print(jenn_fit_n)

#plot total nitrogen versus dissolved oxygen
ggplot(jenn, aes(x=tn_ug, y=dissolvedOxygen, color=subsurface))+
  geom_point()+
  geom_abline(intercept = coef(jenn_fit_n)[1], 
              slope = coef(jenn_fit_n)[3], 
              color = "steelblue1", size = 1)+
  geom_abline(intercept = coef(jenn_fit_n)[1] + coef(jenn_fit_n)[2], 
              slope = coef(jenn_fit_n)[3] + coef(jenn_fit_n)[4], 
              color = "steelblue4", size = 1)+
  scale_color_manual(values = c("surface" = "steelblue1", "subsurface" = "steelblue4"))+
  scale_x_continuous(breaks = seq(0, 3500, by = 500))+
  scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab("total nitrogen (micrograms)")+
  ylab("dissolved oxygen (units?)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "depth")

```


```{r Heirarchical at surface}

lakes_processed_surface <- lakes_processed %>% 
  filter(subsurface_indicator==0)
# Fit hierarchical linear mixed-effects model
fit <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_processed_surface)

# Summary of the model
summary(fit)

# Print the model
print(fit)

# Extract the random effects
random_effects <- fit@u

# Plotting the relationship between total phosphorus (tp_ug) and dissolved oxygen (dissolvedOxygen) by lakename
ggplot(lakes_processed_surface, aes(x = tp_ug, y = dissolvedOxygen, color = lakename)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +  # Add a linear regression line
  labs(x = "Total Phosphorus (µg)", y = "Dissolved Oxygen (mg/L)", color = "Lake Name") +
  theme_minimal() +
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Lake at Surface") +
  theme(legend.position = "bottom")

```

```{r Heirarchical summer}

lakes_processed_summer <- lakes_processed %>% 
  filter(summer_indicator==1)
# Fit hierarchical linear mixed-effects model
fit <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_processed_summer)

# Summary of the model
summary(fit)

# Print the model
print(fit)

# Extract the random effects
random_effects <- fit@u

# Plotting the relationship between total phosphorus (tp_ug) and dissolved oxygen (dissolvedOxygen) by lakename
ggplot(lakes_processed_summer, aes(x = tp_ug, y = dissolvedOxygen, color = lakename)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +  # Add a linear regression line
  labs(x = "Total Phosphorus (µg)", y = "Dissolved Oxygen (mg/L)", color = "Lake Name") +
  theme_minimal() +
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Lake in Summer") +
  theme(legend.position = "bottom")

```

