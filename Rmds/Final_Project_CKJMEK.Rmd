---
title: "ENV 710 Final Project"
author: "Emma Kaufman, Cara Kuuskvere, Jenn McNeill"
date: "2024-04-10"
output: pdf_document
editor_options: 
  chunk_output_type: console
toc: true
---

# Introduction

In this report we examine the relationship of total phosphorus concentration on dissolved oxygen levels in Wisconsin lakes. Adequate levels of dissolved oxygen in lakes are crucial for the aquatic species that reside there. DO levels are at risk for becoming dangerously low when excess organic materials, such as algae, decompose, a process called eutrophication (US EPA, 2013). As a result, it is important to limit algae growth in lakes. When there is too much phosphorus in lakes conditions become suitable for algae blooms resulting in eutrophication. In addition, toxins found in algae blooms are harmful to human and animal health (US EPA, 2013).

Total phosphorus in lakes is influenced by rainfall, stream flow, overland runoff, groundwater discharge, decomposition of organic matter, and soil erosion. Humans contribute to phosphorus levels in lakes due to fertilization of agricultural fields and lawns, leaking waste water, and increased urbanization (Lee, 1973). Most phosphorus in lakes takes the form of dissolved or particulate phosphorus, and total phosphorus is a measure of all forms of phosphorus potentially available to algae (Total Nitrogen/Total Phosphorus and Chlorophyll a, n.d.).

Our research questions and associated hypotheses are three-fold:

-   Is there a difference in the impact of total phosphorus on dissolved oxygen levels in the spring versus the summer?
    -   $H_0$: There is no difference in the impact of phosphorus on DO in the spring versus the summer.
    -   $H_a$: There is a difference in the impact of phosphorus on DO in spring versus summer.
-   Is there a difference in the impact of total phosphorus on dissolved oxygen levels in shallow versus subsurface lake water?
    -   $H_0$: There is no difference in the impact of phosphorus on DO in surface and subsurface lake water.
    -   $H_a$: There is a difference in the impact of phosphorus on DO in surface and subsurface lake water.
-   Do West Long, East Long, Peter, and Paul Lake all exhibit the same relationship of how total phosphorus impacts dissolved oxygen levels?
    -   $H_0$: All of these lakes display the same relationship of how total phosphorus impacts dissolved oxygen levels.
    -   $H_a$: The impact of phosphorus on DO is different across these lakes.

# Methods

The data for this project are from lakes in the North Temperate Lakes District of Wisconsin. They were collected at the Long Term Ecological Research station located there. The physical and chemical variables were measured at a central station in the deepest point of each lake. Most measurements were made between 8 and 9 am. The nutrient measurements were made along vertical profiles at varied depth intervals. The dissolved oxygen chemistry data from 1991-1999 were obtained from a Lachat auto-analyser. The methods of data collection from 1991-1997 are described in more detail by Carpenter at al. (2001). More information on this data can be found here: <https://lter.limnology.wisc.edu/core-datasets/>.

These datasets contain daily nutrient and lake chemistry data at 26 different lakes within the North Temperate Lakes District in Wisconsin over 25 years. The variables between the two datasets include the lake depth, total nitrogen, total phosphorus, nh34, no23, and po4 concentrations, as well as lake temperature, dissolved oxygen, and irradiance. For the purposes of this project we focus on using lake depth, total phosphorus, and dissolved oxygen data across 4 lakes: East Long Lake, Paul Lake, Peter Lake, and West Long Lake from 1994 to 1999. A table of these variables is found below:

| Variable Analyzed     | Unit of Measure               | Type of Variable           |
|-------------------|---------------------------|--------------------------|
| Lake Name             | Name Factor                   | Character/ Factor          |
| Depth                 | Meters below surface          | Numeric ; binary indicator |
| Season                | Spring (May)/ Summer (August) | Binary indicator           |
| Dissolved Oxygen (DO) | mg/ Liter                     | Numeric                    |
| Phosphorus            | $\mu$g                        | Numeric                    |

Our dependent variable is dissolved oxygen (mg/L) and our independent variables are total phosphorus ($\mu$g), season (May or August, coded as spring or summer), and depth (\<6 ft as surface, deeper than 6 ft as subsurface).

Our initial data exploration of the range and measures of central tendency of each of our numeric variables is as follows:

| Variable                   | Mean  | Median | Range          |
|----------------------------|-------|--------|----------------|
| Total Phosphorus $\mu$g    | 34.91 | 19.47  | -3.04 - 284.03 |
| Depth Meters below surface | 3.67  | 2      | 0- 12          |
| Dissolved Oxygen mg/ Liter | 5.96  | 7      | 0 - 17.3       |

In this report we use linear models to estimate dissolved oxygen across these lakes based on total phosphorus content sampled within the lakes' water columns. We examine the difference in the relationship of DO and total phosphorus in spring and summer, as well as the difference in the relationship of DO and total phosphorus at the water surface versus deeper in the water column. Finally, we use a hierarchical linear model to examine the DO and total phosphorus relationship across East Long, West Long, Peter, and Paul lakes.

In order to check the assumptions of these models, we plot the residuals against a normal distribution (qq plot) as well as the residuals vs fitted values to check for constant variance. We also fit training models with 80% of the data and checked our mean absolute percentage error (MAPE) values to see the accuracy of our model fit versus our observed data.

```{r load packages, include=FALSE, message=FALSE, warning=FALSE}

library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(tidyverse)
library(lubridate)
library(latex2exp)
library(lubridate)
library(lme4)

```

```{r import and wrangle data, include=FALSE, message=FALSE, warning=FALSE}

lakes_raw <- read.csv("./Data/Raw/NTL-LTER_Lake_Nutrients_Raw.csv",stringsAsFactors = TRUE) 
do_raw <- read.csv("Data/Raw/NTL-LTER_Lake_ChemistryPhysics_Raw.csv",stringsAsFactors = TRUE)

lakes_raw$sampledate <- mdy(lakes_raw$sampledate)
do_raw$sampledate <- mdy(do_raw$sampledate)

lakes_processed <- lakes_raw %>%
  select(lakename, sampledate, depth, tn_ug, tp_ug, nh34, no23, po4) %>%
  na.omit() %>%
  filter(lakename %in% c("Paul Lake", "West Long Lake", "Peter Lake", "East Long Lake")) %>%
  #filter(year(sampledate) >= 1994 & year(sampledate) <= 1999) %>%
  mutate(year = factor(year(sampledate)),
         month = factor(month(sampledate)),
         subsurface = factor(ifelse(depth > 6, "subsurface", "surface")),
         season = factor(ifelse(month == 5, "spring", ifelse(month == 8, "summer", NA)))) %>%
  filter(month %in% c(5,6,7,8)) %>%
  mutate(depth = round(depth * 2) / 2)

lakes_processed$subsurface_indicator <- 
  ifelse(lakes_processed$subsurface == "subsurface", 1, 0)

lakes_processed$summer_indicator <- 
  ifelse(lakes_processed$season == "summer", 1, 0)

lakes_processed <- left_join(lakes_processed, 
                             select(do_raw, lakename, sampledate, depth, dissolvedOxygen), 
                             by = c("lakename", "sampledate", "depth"))

lake_1994 <- lakes_processed %>% 
  filter(year %in% c(1994)) %>% 
  filter(po4<20) %>% 
  filter(tp_ug<100)

```

```{r Data Exploration}
# Calculate mean, median, and range for TP, depth, and DO
mean_tp <- mean(lakes_processed$tp_ug)
median_tp <- median(lakes_processed$tp_ug)
range_tp <- range(lakes_processed$tp_ug)

mean_depth <- mean(lakes_processed$depth)
median_depth <- median(lakes_processed$depth)
range_depth <- range(lakes_processed$depth)

mean_DO <- mean(na.omit(lakes_processed_summer$dissolvedOxygen))
median_DO <- median(na.omit(lakes_processed_summer$dissolvedOxygen))
range_DO <- range(na.omit(lakes_processed_summer$dissolvedOxygen))
```

## MODEL FIT ONE: Dissolved Oxygen (DO) by Total Phosphorus (TP) with a Seasonal Binary Indicator Variable and a Seasonal Interaction Term

```{r seasonal model, include=FALSE, message=FALSE, warning=FALSE}

two_season_clean <- lakes_processed %>% 
  na.omit()

two_season_fit <- lm(dissolvedOxygen ~ summer_indicator + tp_ug + summer_indicator*tp_ug,
                     data = two_season_clean)

summary(two_season_fit)

```

| Variable              | Value                | Interpretation                                                                     |
|-------------------|-------------------|----------------------------------|
| $\beta_0$ (intercept) | 10.15 mg/L           | Expected value of DO in spring with 0 TP                                           |
| $\beta_1$             | -2.36 mg/L           | Difference in DO between spring and summer with 0 TP                               |
| $\beta_2$             | -0.067 (mg/L)/$\mu$g | Expected change in D0 for each unit increase in TP in the spring                   |
| $\beta_3$             | 0.02 (mg/L)/$\mu$g   | Adjustment to slope for interaction for each unit increase in TP during the summer |

```{r seasonal model holdout and MAPE calculation, include = FALSE, message=FALSE, warning=FALSE}

# Holdout 20% of data for testing, 80% for training

two_season_clean$holdout <- rbinom(n=nrow(two_season_clean),size=1,prob=0.2)
two_season_training <- two_season_clean %>% filter(holdout==0)
two_season_testing <- two_season_clean %>% filter(holdout==1)

two_season_fit_test <- lm(dissolvedOxygen ~ summer_indicator + tp_ug + summer_indicator*tp_ug,
                          data = two_season_training)

print(two_season_fit_test)

two_season_fit_test_beta_0 <- coef(two_season_fit)[1]
two_season_fit_test_beta_1 <- coef(two_season_fit)[2]
two_season_fit_test_beta_2 <- coef(two_season_fit)[3]
two_season_fit_test_beta_3 <- coef(two_season_fit)[4]

two_season_testing$do_predicted <- two_season_fit_test_beta_0 + 
    two_season_fit_test_beta_1*two_season_testing$summer_indicator +
    two_season_fit_test_beta_2*two_season_testing$tp_ug +
    two_season_fit_test_beta_3*two_season_testing$summer_indicator*two_season_testing$tp_ug

MAPE_seasonal <- sqrt(mean((two_season_testing$dissolvedOxygen - two_season_testing$do_predicted)^2))

print(MAPE_seasonal)

```

```{r seasonal model plot, fig.cap="Figure 1", echo=FALSE, message=FALSE, warning=FALSE}

ggplot(two_season_clean, aes(x=tp_ug, y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_fit)[1],
              slope = coef(two_season_fit)[3],
              color = "thistle3", size = 1)+
  geom_abline(intercept = coef(two_season_fit)[1] + coef(two_season_fit)[2],
              slope = coef(two_season_fit)[3] + coef(two_season_fit)[4],
              color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  scale_x_continuous(breaks = seq(0, 300, by = 50))+
  scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Total Phosphorus" ~ (µg)))+
  ylab("Dissolved Oxygen (mg/L)")+
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Season")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

```

```{r seasonal model residuals, include = FALSE, message=FALSE, warning=FALSE}
plot(two_season_fit)
```

### Results Model One

The results of this model are that the expected value of dissolved oxygen across all of the lakes with no phosphorus is 10.15 mg/L in the spring. In the summer, dissolved oxygen levels when there is no phosphorus decrease by 2.36 mg/L.

The expected change in DO for each unit increase in total phosphorus during the spring is -0.067 (mg/L)/$\mu$g . In the summer this change increases by 0.02.

These model results are displayed with the observed data in Figure 1. This linear model assumes that the residuals are normally distributed and have constant variance. The plots that examine these assumptions are found in the appendix plot 1. They show that these assumptions were not met, as the residuals do not follow a normal distribution (as seen in the qq plot), and the variance is not constant (in the residuals v fitted plot).

We tried to improve our model by normalizing the data with a log transformation of total phosphorus. The results of this are in the appendix (Appendix plot log-transform). We still did not see normal distribution of residuals or constant variance of residuals. Additionally, we tried to use a subset of the DO data and fit our model to those data (Appendix plot subset DO), but still did not have promising results for our model assumptions. We chose to go forward with the original data because it is the most interpretable.

These results show that with increasing concentrations of phosphorus, there is a decrease in dissolved oxygen, and that the impact of phosphorus on DO levels is slightly stronger in the spring. These results are significant (all of the p-values are less than 0.05 for each coefficient), but that doesn't mean they are the best model of these data. The MAPE score of 2.99 shows that there is high error when you compare the fitted and observed data.

## MODEL FIT TWO: Dissolved Oxygen (DO) by Total Phosphorus (TP) with a Water Depth Binary Indicator Variable and a Water Depth Interaction Term

```{r depth model, include = FALSE, message=FALSE, warning=FALSE}

jenn <- lakes_processed

jenn$subsurface_tp_ug = jenn$tp_ug * jenn$subsurface_indicator
jenn$subsurface_tn_ug = jenn$tn_ug * jenn$subsurface_indicator

jenn_fit_p <- lm(formula = dissolvedOxygen ~ subsurface_indicator + tp_ug + subsurface_tp_ug, 
                 data = jenn)

print(jenn_fit_p)

```

| Variable              | Value       | Interpretation                                                          |
|-------------------|-------------------|----------------------------------|
| $\beta_0$ (Intercept) | 8.52 mg/L   | Expected value of DO in surface water with 0 tp                         |
| $\beta_1$             | -7.67 mg/L  | Difference in DO b/w sub- and surface water with 0 tp                   |
| $\beta_2$             | -.0002 mg/L | Expected change in D0 for each unit increase in tp in surface water     |
| $\beta_3$             | -0.003 mg/L | Adjustment to slope for interaction term between tp in subsurface water |

```{r depth model holdout and MAPE calculation, include = FALSE, message=FALSE, warning=FALSE}

# Holdout 20% of data for testing, 80% for training

jenn$holdout <- rbinom(n=nrow(jenn),size=1,prob=0.2)
jenn_training <- jenn %>% filter(holdout==0)

jenn_testing <- jenn %>% filter(holdout==1)

jenn_fit_p_test <- lm(formula = dissolvedOxygen ~ subsurface_indicator + tp_ug + subsurface_tp_ug, data = jenn_training)

print(jenn_fit_p_test)

jenn_fit_p_test_beta_0 <- 8.531495
jenn_fit_p_test_beta_1 <- -7.680194
jenn_fit_p_test_beta_2 <- 0.001925
jenn_fit_p_test_beta_3 <- -0.005985

jenn_testing$do_predicted <- jenn_fit_p_test_beta_0 + 
    jenn_fit_p_test_beta_1*jenn_testing$subsurface_indicator +
    jenn_fit_p_test_beta_2*jenn_testing$tp_ug +
    jenn_fit_p_test_beta_3*jenn_testing$subsurface_tp_ug

MAPE_depth <- sqrt(mean((jenn_testing$dissolvedOxygen - jenn_testing$do_predicted)^2, na.rm = TRUE))

print(MAPE_depth)

```

```{r depth plot, fig.cap = "Figure 2", echo=FALSE, message=FALSE, warning=FALSE}

#plot total phosphorus versus dissolved oxygen
ggplot(jenn, aes(x=tp_ug, y=dissolvedOxygen, color=subsurface))+
  geom_point()+
  geom_abline(intercept = coef(jenn_fit_p)[1], 
              slope = coef(jenn_fit_p)[3], 
              color = "steelblue1", size = 1)+
  geom_abline(intercept = coef(jenn_fit_p)[1] + coef(jenn_fit_p)[2], 
              slope = coef(jenn_fit_p)[3] + coef(jenn_fit_p)[4], 
              color = "steelblue4", size = 1)+
  scale_color_manual(values = c("surface" = "steelblue1", "subsurface" = "steelblue4"))+
  scale_x_continuous(breaks = seq(0, 300, by = 50))+
  scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Total Phosphorus" ~ (µg)))+
  ylab("Dissolved Oxygen (mg/L)")+
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Water Depth")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "depth")

```

```{r depth model residuals, include = FALSE, message=FALSE, warning=FALSE}

plot(jenn_fit_p)

```

### Results Model Two

The results from this model tell us that the expected value for dissolved oxygen in surface waters with zero total phosphorus is 8.52 mg/L. In subsurface waters with zero total phosphorus, the dissolved oxygen level decreases by 7.67 mg/L. The rate of change of the dissolved oxygen concentration for each unit increase of micrograms of total phosphorus in the water is -0.0002 in surface waters and -0.003 for subsurface waters.

Figure 2 shows a graphical representation of this linear model. These data are consistent with our assumptions given what we know about the relationship between dissolved oxygen and total phosphorus. As total phosphorus levels increase, the phosphorus in the water stimulates the growth of algae, a process known as eutrophication. This algae consumes the oxygen in the water as it decomposes, and the level of dissolved oxygen decreases. Simultaneously, the algae growth in the water halts the production of oxygen because the water gets murkier and plants are not able to photosynthesize as efficiently. Knowing that this process occurs, it is logical that the levels of dissolved oxygen are lower in deeper waters because the sun penetration is weaker and plants are not photosynthesizing enough to overcome the depletion of oxygen caused by eutrophication. It follows that the downward slope of the line is also logical because the dissolved oxygen is decreasing as total phosphorus increases.

Although the results of this linear model are consistent with our predictions, the model still has a high degree of error. The QQ plot shown in Appendix Plot 2 does not form a straight line, which means that the residuals from this model do not follow a normal distribution. The clouds of data points in Figure 2 are consistent with this observation; the points are not evenly distributed about the best fit line. Additionally, the MAPE score of 2.01 is an improvement as compared to the first model we fit but still shows a high degree of error.

## MODEL FIT THREE: Dissolved Oxygen by Total Phosphorus with a Hierarchical Linear Mixed Effects Lake Variable

```{r hierarchical model, include = FALSE, message=FALSE, warning=FALSE}

# Fit hierarchical linear mixed-effects model
fit <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_processed)

# Summary of the model
summary(fit)

# Print the model
print(fit)

# Extract the random effects
random_effects <- fit@u

```

a.  $\beta_0$ (Intercept): 8.68 mg/L

This represents the expected value of dissolved oxygen with zero total phosphorus.

b.  $\beta_1$ (tp_ug): -0.055 mg/L

This represents the change in dissolved oxygen for each unit increase in total phosphorus in surface water.

| Variable              | Value               | Interpretation                                          |
|-------------------|-------------------|----------------------------------|
| $\beta_0$ (Intercept) | 8.68 mg/L           | Expected value of D0 with zero phosphorus               |
| $\beta_1$ (tp_ug)     | -0.55 (mg/L)/$\mu$g | Change in dissolved oxygen for each unit increase in TP |

```{r hierarchical model holdout and MAPE calculation, include = FALSE, message=FALSE, warning=FALSE}

# Holdout 20% of data for testing, 80% for training
lakes_processed$holdout <- rbinom(n=nrow(lakes_processed),size=1,prob=0.2)
lakes_training <- lakes_processed %>% filter(holdout==0)
lakes_testing <- lakes_processed %>% filter(holdout==1)
fit_test <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_training)

print(fit_test)

fit_test_beta_0 <- 8.70408
fit_test_beta_1 <- -0.05471

lakes_testing$do_predicted <- fit_test_beta_0 + 
    fit_test_beta_1*lakes_testing$tp_ug

MAPE_hierarchical <- sqrt(mean((lakes_testing$dissolvedOxygen - lakes_testing$do_predicted)^2, na.rm = TRUE))

print(MAPE_hierarchical)

```

```{r hierarchical plot, fig.cap = "Figure 3", echo=FALSE, message=FALSE, warning=FALSE}

ggplot(lakes_processed, aes(x = tp_ug, y = dissolvedOxygen, color = lakename)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +  # Add a linear regression line
  labs(x = "Total Phosphorus (µg)", y = "Dissolved Oxygen (mg/L)", color = "Lake Name") +
  scale_x_continuous(breaks = seq(0, 300, by = 50))+
  scale_y_continuous(breaks = seq(0, 20, by = 5))+
  theme_light() +
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Lake") +
  theme(legend.position = "right")

```

```{r hierarchical model residuals, include = FALSE, message=FALSE, warning=FALSE}

# Residual Plot (Residuals vs Fitted)
residuals <- resid(fit)
fitted_values <- fitted(fit)

residual_plot <- data.frame(residuals = residuals, fitted_values = fitted_values)

ggplot(residual_plot, aes(x = fitted_values, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Fitted Values", y = "Residuals") +
  ggtitle("Residuals vs Fitted")

# QQ Plot (Normal Q-Q plot)
qq_plot <- qqnorm(residuals, main = "Normal Q-Q Plot")

# Random Effects Plot (Dot plot of random effects)
random_effects <- ranef(fit)$lakename

random_effects_plot <- data.frame(lakename = rownames(random_effects), random_effect = random_effects[, 1])

```

### Model Three Results

This model evaluates dissolved oxygen (dependent) based upon total phosphorus (independent) in each lake in our subset. The hierarchical model evaluates these two variables, with consideration that each lake may introduce differences in the relationship between the two, whose impacts should not be reflected in the pure randomness between the two variables but can be generalized between all lakes. Figure 3 shows a graphical representation of this model. Like the previous two models, linearity is assumed in the data, along with independence due to the nature of the data collection process. Normality of residuals and homoscedasticity are assumptions made of successful models, however our diagnostic plots demonstrate that these assumptions were not met.

Based on the full dataset, the fixed estimate for the total phosphorus in micrograms is approximately -0.056, and for the training dataset it is approximately -0.054. Given the fixed estimate based on the full dataset, this suggests that for every one-unit increase in total phosphorus, dissolved oxygen decreases by approximately 0.056 units. The random effects, particularly the intercept variance at the lake level (0.6096), indicate that there are differences among lakes that contribute to the variation in dissolved oxygen beyond what can be explained by total phosphorus alone.

The model's assumptions regarding linearity and independence hold, as expected based on the nature of the hierarchical model. However, the diagnostic plots reveal departures from normality of residuals and homoscedasticity, suggesting that the model may not fully capture all nuances in the data. Despite these limitations, the model provides valuable insights into the relationship between total phosphorus and dissolved oxygen, accounting for lake-specific effects that might otherwise confound the analysis.

In terms of model performance, the Mean Absolute Percentage Error (MAPE) score of 3.32 indicates a fairly high degree of error when comparing the fitted values to the observed data. This suggests that while the model may provides useful estimates, there is muhch room for improvement in capturing the variability in dissolved oxygen explained by total phosphorus across different lakes. Further refinements or alternative modeling approaches may be warranted to enhance predictive accuracy and better account for the complexities in the data.

# Analysis and Conclusion

Model Performance: To assess the effectiveness of our models in predicting dissolved oxygen (DO) levels based on total phosphorus (TP) concentrations, we evaluated three different models: Depth Model, Seasonal Model, and Hierarchical Model by Lakename. Each model's performance was measured using the Mean Absolute Percentage Error (MAPE) metric, providing insights into the accuracy of predictions compared to observed data.

| Model                          | MAPE |
|--------------------------------|------|
| Depth Model                    | 2.42 |
| Seasonal Model                 | 3.02 |
| Hierarchical Model by Lakename | 3.31 |

The MAPE values indicate the percentage difference between predicted and observed DO values, with lower MAPE values indicating better model performance. Among the models evaluated, the Depth Model yielded the lowest MAPE, suggesting it provides the most accurate predictions compared to the other models evaluated

Residual Analysis and Model Assumptions

Despite the relatively lower MAPE of the Depth Model, all three models exhibited issues with the distribution of residuals and model assumptions. Residual analysis revealed non-normal distribution and heteroscedasticity, indicating that the models may not fully capture the variability in DO explained by TP concentrations.

Hypothesis Testing Results

Based on the hypothesis tests conducted for each model given the p-values of our statistical evaluations, all coefficients associated with TP were found to be statistically significant (p \< 0.05). This indicates a significant relationship between TP concentrations and DO levels across the lakes studied.

Interpretation and Insights

Our analysis suggests a negative relationship between TP concentrations and DO levels, consistent with the phenomenon of eutrophication where increased TP leads to decreased DO due to algae growth and oxygen consumption. However, the presence of distinct data clusters, as observed in residual plots, raises questions about the exact nature of this relationship.

The two clusters of data, one showing high DO and low TP and the other showing consistently low DO across a range of TP values, imply potential thresholds or critical points where TP concentrations drastically impact DO levels. Beyond these thresholds, DO levels may drop significantly, possibly indicating eutrophication events leading to near-zero DO levels.

Limitations and Future Directions While our models provide valuable insights into the TP-DO relationship, several limitations exist. The non-normality of residuals and heteroscedasticity indicate that our models may not fully capture all nuances in the data. Future research could explore alternative modeling approaches or data transformations to improve model accuracy and address these limitations.

Additionally, our study focused on TP as the sole predictor of DO levels. Including other variables such as temperature, pH, and nutrient concentrations could enhance the predictive power of our models and provide a more comprehensive understanding of factors influencing DO in lakes.

In conclusion, while our models demonstrate a negative relationship between TP concentrations and DO levels, further refinement and exploration are needed to better predict and understand the complexities of this relationship, especially regarding critical thresholds and non-linear effects.

# Bibliography

Carpenter, S. R., Cole, J. J., Hodgson, J. R., Kitchell, J. F., Pace, M. L., Bade, D., ... & Schindler, D. E. (2001). Trophic cascades, nutrients, and lake productivity: whole‐lake experiments. Ecological monographs, 71(2), 163-186.

Lee, G. F. (1973). Role of phosphorus in eutrophication and diffuse source control. In Phosphorus in Fresh Water and the Marine Environment (pp. 111-128). Pergamon.

Total nitrogen/total phosphorus and chlorophyll a: Volunteer data entry and information: indiana clean lakes program: indiana university. (n.d.). Indiana Clean Lakes Program. Retrieved April 15, 2024, from <https://clp.indiana.edu/volunteer-data/phosphorus-chlorophyll.html>

US EPA, O. (2013, November 20). Indicators: Dissolved oxygen [Overviews and Factsheets]. <https://www.epa.gov/national-aquatic-resource-surveys/indicators-dissolved-oxygen>

US EPA, O. (2013, November 27). Indicators: Phosphorus [Overviews and Factsheets]. <https://www.epa.gov/national-aquatic-resource-surveys/indicators-phosphorus>

# Appendix

### Model One Residuals

```{r model one residuals, fig.cap = "Appendix plot 1", echo = FALSE, message=FALSE, warning=FALSE}

plot(two_season_fit)

```

### Model Two Residuals

```{r model two residuals, fig.cap = "Appendix plot 2", echo=FALSE, message=FALSE, warning=FALSE}

plot(jenn_fit_p)

```

### Model Three Residuals

```{r model three residuals,fig.cap = "Appendix plot 3", echo = FALSE, message=FALSE, warning=FALSE}

# Residual Plot (Residuals vs Fitted)
residuals <- resid(fit)
fitted_values <- fitted(fit)

residual_plot <- data.frame(residuals = residuals, fitted_values = fitted_values)

ggplot(residual_plot, aes(x = fitted_values, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Fitted Values", y = "Residuals") +
  ggtitle("Residuals vs Fitted")

# QQ Plot (Normal Q-Q plot)
qq_plot <- qqnorm(residuals, main = "Normal Q-Q Plot")

# Random Effects Plot (Dot plot of random effects)
random_effects <- ranef(fit)$lakename

random_effects_plot <- data.frame(lakename = rownames(random_effects), random_effect = random_effects[, 1])

```

```{r exploratory plots, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(lakes_processed)+
  geom_point(aes(y=dissolvedOxygen,x=subsurface_indicator))+
  theme_light()

ggplot(lakes_processed)+
  geom_point(aes(y=dissolvedOxygen,x=season))+
  theme_light()
  
```

```{r tp by month with po4, echo=FALSE, message=FALSE, warning=FALSE}

fit_2 <- lm(formula = tp_ug ~ month + po4, data = lake_1994)
print(fit_2)

ggplot(lake_1994, aes(x=po4, y=tp_ug, color=month))+
  geom_point()+
  geom_abline(intercept = coef(fit_2)[1], slope = coef(fit_2)[5], 
              color = "orchid3")+
  geom_abline(intercept = coef(fit_2)[1] + coef(fit_2)[2], slope = coef(fit_2)[5], 
              color = "cyan4")+
  geom_abline(intercept = coef(fit_2)[1] + coef(fit_2)[3], slope = coef(fit_2)[5], 
              color = "slateblue")+
  geom_abline(intercept = coef(fit_2)[1] + coef(fit_2)[4], slope = coef(fit_2)[5], 
              color = "tomato3")+
  scale_color_manual(values = c("5" = "orchid3", 
                                "6" = "cyan4",
                                "7" = "slateblue",
                                "8" = "tomato3"))+
  scale_x_continuous(breaks = seq(0, 20, by = 5))+
  scale_y_continuous(breaks = seq(0, 100, by = 20))+
  ylab(expression("Total Phosphorus" ~ (µg))) +
  xlab(expression("Phosphate" ~ (µg))) +
  ggtitle("Change in Total Phosphorus in Samples Taken 
in May, June, July, and August")+
  theme_light()+
  theme(legend.position="bottom")

```

```{r tp by lake with po4, echo=FALSE, message=FALSE, warning=FALSE}

fit_4 <- lm(formula = tp_ug ~ lakename + po4, data = lake_1994)
print(fit_4)

ggplot(lake_1994, aes(x=po4, y=tp_ug, color=lakename))+
  geom_point()+
  geom_abline(intercept = coef(fit_4)[1], slope = coef(fit_4)[5], 
              color = "orchid3")+
  geom_abline(intercept = coef(fit_4)[1] + coef(fit_4)[2], slope = coef(fit_4)[5], 
              color = "cyan4")+
  geom_abline(intercept = coef(fit_4)[1] + coef(fit_4)[3], slope = coef(fit_4)[5], 
              color = "slateblue")+
  geom_abline(intercept = coef(fit_4)[1] + coef(fit_4)[4], slope = coef(fit_4)[5], 
              color = "tomato3")+
  scale_color_manual(values = c("East Long Lake" = "orchid3", 
                                "Paul Lake" = "cyan4",
                                "Peter Lake" = "slateblue",
                                "West Long Lake" = "tomato3"))+
  scale_x_continuous(breaks = seq(0, 20, by = 5))+
  scale_y_continuous(breaks = seq(0, 100, by = 20))+
  ylab(expression("Total Phosphorus" ~ (µg))) +
  xlab(expression("Phosphate" ~ (µg))) +
  ggtitle("Change in Total Phosphorus in Samples Taken 
at East Long Lake, Paul Lake, Peter Lake, and West Long Lake")+
  theme_light()+
  theme(legend.position="bottom")

```

```{r exploratory for appendix looking at nitrogen and season v DO, echo=FALSE, message=FALSE, warning=FALSE}

two_season_nitrogen <- lm(dissolvedOxygen ~ summer_indicator + tn_ug + summer_indicator*tn_ug,
                     data= two_season_clean)

 ggplot(two_season_clean, aes(x=tn_ug, y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_nitrogen)[1],
              slope = coef(two_season_nitrogen)[3],
              color = "thistle3", size = 1)+
  geom_abline(intercept = coef(two_season_nitrogen)[1] + coef(two_season_nitrogen)[2],
              slope = coef(two_season_nitrogen)[3] + coef(two_season_nitrogen)[4],
              color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  # scale_x_continuous(breaks = seq(0, 300, by = 50))+
  # scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Total Nitrogen" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

```

```{r depth model with nitrogen, echo=FALSE, message=FALSE, warning=FALSE}

jenn_fit_n <- lm(formula = dissolvedOxygen ~ subsurface_indicator + tn_ug + subsurface_tn_ug, 
                 data = jenn)

print(jenn_fit_n)

#plot total nitrogen versus dissolved oxygen
ggplot(jenn, aes(x=tn_ug, y=dissolvedOxygen, color=subsurface))+
  geom_point()+
  geom_abline(intercept = coef(jenn_fit_n)[1], 
              slope = coef(jenn_fit_n)[3], 
              color = "steelblue1", size = 1)+
  geom_abline(intercept = coef(jenn_fit_n)[1] + coef(jenn_fit_n)[2], 
              slope = coef(jenn_fit_n)[3] + coef(jenn_fit_n)[4], 
              color = "steelblue4", size = 1)+
  scale_color_manual(values = c("surface" = "steelblue1", "subsurface" = "steelblue4"))+
  scale_x_continuous(breaks = seq(0, 3500, by = 500))+
  scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab("total nitrogen (micrograms)")+
  ylab("dissolved oxygen (units?)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "depth")

```

```{r Heirarchical at surface, echo=FALSE, message=FALSE, warning=FALSE}

lakes_processed_surface <- lakes_processed %>% 
  filter(subsurface_indicator==0)
# Fit hierarchical linear mixed-effects model
fit <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_processed_surface)

# Summary of the model
summary(fit)

# Print the model
print(fit)

# Extract the random effects
random_effects <- fit@u

# Plotting the relationship between total phosphorus (tp_ug) and dissolved oxygen (dissolvedOxygen) by lakename
ggplot(lakes_processed_surface, aes(x = tp_ug, y = dissolvedOxygen, color = lakename)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +  # Add a linear regression line
  labs(x = "Total Phosphorus (µg)", y = "Dissolved Oxygen (mg/L)", color = "Lake Name") +
  theme_minimal() +
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Lake at Surface") +
  theme(legend.position = "bottom")

```

```{r Heirarchical summer, echo=FALSE, message=FALSE, warning=FALSE}

lakes_processed_summer <- lakes_processed %>% 
  filter(summer_indicator==1)
# Fit hierarchical linear mixed-effects model
fit <- lmer(dissolvedOxygen ~ tp_ug + (1|lakename), data = lakes_processed_summer)

# Summary of the model
summary(fit)

# Print the model
print(fit)

# Extract the random effects
random_effects <- fit@u

# Plotting the relationship between total phosphorus (tp_ug) and dissolved oxygen (dissolvedOxygen) by lakename
ggplot(lakes_processed_summer, aes(x = tp_ug, y = dissolvedOxygen, color = lakename)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +  # Add a linear regression line
  labs(x = "Total Phosphorus (µg)", y = "Dissolved Oxygen (mg/L)", color = "Lake Name") +
  theme_minimal() +
  ggtitle("Dissolved Oxygen vs Total Phosphorus by Lake in Summer") +
  theme(legend.position = "bottom")

```

```{r new wrangling with all years and DO less than 5, echo=FALSE, message=FALSE, warning=FALSE}

lakes_all_years <- lakes_raw %>%
  select(lakename, sampledate, depth, tn_ug, tp_ug, nh34, no23, po4) %>%
  na.omit() %>%
  filter(lakename %in% c("Paul Lake", "West Long Lake", "Peter Lake", "East Long Lake")) %>%
  mutate(year = factor(year(sampledate)),
         month = factor(month(sampledate)),
         subsurface = factor(ifelse(depth > 1, "subsurface", "surface")),
         season = factor(ifelse(month == 5, "spring", ifelse(month == 8, "summer", NA)))) %>%
  filter(month %in% c(5,6,7,8)) %>%
  mutate(depth = round(depth * 2) / 2)

lakes_all_years$subsurface_indicator <- 
  ifelse(lakes_all_years$subsurface == "subsurface", 1, 0)

lakes_all_years$summer_indicator <- 
  ifelse(lakes_all_years$season == "summer", 1, 0)

lakes_all_years <- left_join(lakes_all_years, 
                             select(do_raw, lakename, sampledate, depth, dissolvedOxygen), 
                             by = c("lakename", "sampledate", "depth"))

lakes_all_years_DO_subset <- lakes_all_years %>%
  filter(dissolvedOxygen <= 5)

```

```{r log transformation, fig.cap = "Appendix plot log-transform", echo=FALSE, message=FALSE, warning=FALSE}

two_season_fit_log <- lm(dissolvedOxygen ~ summer_indicator + log(tp_ug) +
                           summer_indicator*tp_ug, data = two_season_clean)

ggplot(two_season_clean, aes(x=log(tp_ug), y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_fit_log)[1],
              slope = coef(two_season_fit_log)[3],
              color = "thistle3", size = 1)+
  geom_abline(intercept = coef(two_season_fit_log)[1] + coef(two_season_fit_log)[2],
              slope = coef(two_season_fit_log)[3] + coef(two_season_fit_log)[4],
              color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  #scale_x_continuous(breaks = seq(0, 300, by = 50))+
  #scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Log Transformed Total Phosphorus" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

```

```{r DO less than 5, fig.cap = "Appendix plot subset DO", echo=FALSE, message=FALSE, warning=FALSE}
lakes_all_years_DO_subset_clean <- lakes_all_years_DO_subset %>% 
  na.omit()

two_season_fit_subset <- lm(dissolvedOxygen ~ summer_indicator + tp_ug +
                           summer_indicator*tp_ug, data = lakes_all_years_DO_subset_clean)

ggplot(lakes_all_years_DO_subset_clean, aes(x=tp_ug, y=dissolvedOxygen, color=season))+
  geom_point()+
  geom_abline(intercept = coef(two_season_fit_subset)[1],
               slope = coef(two_season_fit_subset)[3],
               color = "thistle3", size = 1)+
   geom_abline(intercept = coef(two_season_fit_subset)[1] + coef(two_season_fit_subset)[2],
               slope = coef(two_season_fit_subset)[3] + coef(two_season_fit_subset)[4],
               color = "darkgoldenrod1", size = 1)+
  scale_color_manual(values = c("spring" = "thistle3", "summer" = "darkgoldenrod1"))+
  #scale_x_continuous(breaks = seq(0, 300, by = 50))+
  #scale_y_continuous(breaks = seq(0, 15, by = 5))+
  xlab(expression("Total Phosphorus" ~ (µg)))+
  ylab("dissolved oxygen (mg/L)")+
  theme_light()+
  theme(legend.position="right")+
  labs(color = "Season")

```
